name: Create Branch for Task

on:
  issues:
    types: [opened, edited]

jobs:
  create-task-branch:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
      
      - name: Check if issue is a task and get parent
        id: check-task
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            
            let isTask = false;
            let parentIssueTitle = '';
            let parentIssueNumber = null;
            
            try {
              console.log('=== Checking Issue #' + issue.number + ': ' + issue.title + ' ===');
              
              // Get full issue details with GraphQL to access sub-issue data
              const graphqlQuery = `
                query($owner: String!, $repo: String!, $number: Int!) {
                  repository(owner: $owner, name: $repo) {
                    issue(number: $number) {
                      id
                      number
                      title
                      trackedIssues(first: 1) {
                        nodes {
                          number
                          title
                        }
                      }
                      trackedInIssues(first: 5) {
                        nodes {
                          number
                          title
                        }
                      }
                    }
                  }
                }
              `;
              
              try {
                const result = await github.graphql(graphqlQuery, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  number: issue.number
                });
                
                const trackedInIssues = result.repository.issue.trackedInIssues.nodes;
                console.log('Tracked in issues (parents):', trackedInIssues.length);
                
                if (trackedInIssues.length > 0) {
                  // This issue is tracked in another issue (has a parent)
                  isTask = true;
                  parentIssueNumber = trackedInIssues[0].number;
                  parentIssueTitle = trackedInIssues[0].title;
                  console.log('âœ“ Found parent issue #' + parentIssueNumber + ': ' + parentIssueTitle);
                }
              } catch (graphqlError) {
                console.log('GraphQL query failed:', graphqlError.message);
              }
              
              // Fallback: Check timeline for parent issue events
              if (!isTask) {
                const timeline = await github.rest.issues.listEventsForTimeline({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number
                });
                
                console.log('Timeline events found:', timeline.data.length);
                
                const hasParentIssue = timeline.data.some(event => {
                  if (event.event === 'parent_issue_added' || event.event === 'issue_type_added') {
                    return true;
                  }
                  if (event.event === 'cross-referenced' && event.source?.issue) {
                    // Found a cross-referenced parent issue
                    parentIssueNumber = event.source.issue.number;
                    parentIssueTitle = event.source.issue.title;
                    console.log('Found parent via cross-reference #' + parentIssueNumber + ': ' + parentIssueTitle);
                    return true;
                  }
                  return false;
                });
                
                isTask = hasParentIssue;
              }
              
              // If still no parent title but we know it's a task, try to fetch from issue body
              if (isTask && !parentIssueTitle) {
                const issueBody = issue.body || '';
                const parentMatch = issueBody.match(/(?:Parent issue:|Part of|Subtask of)\s*#(\d+)/i);
                if (parentMatch) {
                  try {
                    parentIssueNumber = parseInt(parentMatch[1]);
                    const { data: parentIssue } = await github.rest.issues.get({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: parentIssueNumber
                    });
                    parentIssueTitle = parentIssue.title;
                    console.log('Found parent from body #' + parentIssueNumber + ': ' + parentIssueTitle);
                  } catch (err) {
                    console.log('Could not fetch parent issue:', err.message);
                  }
                }
              }
              
              if (isTask) {
                console.log('âœ“ Issue #' + issue.number + ' IS A TASK');
                console.log('  Parent: #' + (parentIssueNumber || 'unknown') + ' - ' + (parentIssueTitle || 'not found'));
              } else {
                console.log('âœ— Issue #' + issue.number + ' is NOT a task');
              }
              
              core.setOutput('is_task', isTask.toString());
              core.setOutput('issue_number', issue.number.toString());
              core.setOutput('issue_title', issue.title);
              core.setOutput('parent_issue_title', parentIssueTitle || '');
              core.setOutput('parent_issue_number', (parentIssueNumber || '').toString());
              
              console.log('=== FINAL: is_task=' + isTask + ', parent_title="' + parentIssueTitle + '" ===');
              
              return isTask;
            } catch (error) {
              console.log('Error:', error);
              core.setOutput('is_task', 'false');
              return false;
            }
      
      - name: Create branch for task
        if: steps.check-task.outputs.is_task == 'true'
        id: create-branch
        run: |
          ISSUE_NUMBER="${{ steps.check-task.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.check-task.outputs.issue_title }}"
          PARENT_TITLE="${{ steps.check-task.outputs.parent_issue_title }}"
          
          echo "Creating branch for issue #$ISSUE_NUMBER: $ISSUE_TITLE"
          echo "Parent issue title: $PARENT_TITLE"
          
          # Sanitize the task title for branch name
          SANITIZED_TITLE=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
          
          # Sanitize the parent title for branch prefix
          if [ -n "$PARENT_TITLE" ]; then
            SANITIZED_PARENT=$(echo "$PARENT_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
            # Create branch name with parent prefix
            BRANCH_NAME="${SANITIZED_PARENT}/${ISSUE_NUMBER}-${SANITIZED_TITLE}"
            echo "Using parent-based branch name: $BRANCH_NAME"
          else
            # Fallback to task prefix if no parent found
            BRANCH_NAME="task/${ISSUE_NUMBER}-${SANITIZED_TITLE}"
            echo "No parent found, using fallback: $BRANCH_NAME"
          fi
          
          # Truncate if too long (max 255 chars for git branch names)
          BRANCH_NAME=$(echo "$BRANCH_NAME" | cut -c1-200)
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists"
            echo "branch_created=false" >> $GITHUB_OUTPUT
          else
            # Create and push the branch
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            git checkout -b "$BRANCH_NAME"
            git push origin "$BRANCH_NAME"
            
            echo "Branch $BRANCH_NAME created successfully"
            echo "branch_created=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Link branch to issue via Development
        if: steps.check-task.outputs.is_task == 'true' && steps.create-branch.outputs.branch_created == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = '${{ steps.create-branch.outputs.branch_name }}';
            const issueNumber = ${{ steps.check-task.outputs.issue_number }};
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Method 1: Create a branch reference that links to the issue
            // This creates the Development section link
            try {
              // GitHub's REST API doesn't have a direct "link branch to issue" endpoint
              // But creating a commit reference in a comment creates the link
              const sha = await github.rest.repos.getBranch({
                owner: owner,
                repo: repo,
                branch: branchName
              });
              
              const commitSha = sha.data.commit.sha;
              
              // Create a reference comment that GitHub will recognize
              await github.rest.issues.createComment({
                owner: owner,
                repo: repo,
                issue_number: issueNumber,
                body: `Branch \`${branchName}\` created from commit ${commitSha.substring(0, 7)}`
              });
              
              console.log('Created development link via commit reference');
            } catch (error) {
              console.log('Could not create commit reference:', error.message);
              
              // Fallback: Just mention the branch
              await github.rest.issues.createComment({
                owner: owner,
                repo: repo,
                issue_number: issueNumber,
                body: `Branch \`${branchName}\` created`
              });
            }
      
      - name: Comment on issue with branch details
        if: steps.check-task.outputs.is_task == 'true' && steps.create-branch.outputs.branch_created == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = '${{ steps.create-branch.outputs.branch_name }}';
            const branchUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/tree/${branchName}`;
            const parentTitle = '${{ steps.check-task.outputs.parent_issue_title }}';
            
            let message = `ðŸŒ¿ Branch created: [\`${branchName}\`](${branchUrl})`;
            if (parentTitle) {
              message += `\nðŸ“‹ Parent: ${parentTitle}`;
            }
            message += `\n\nYou can now start working on this task!`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
